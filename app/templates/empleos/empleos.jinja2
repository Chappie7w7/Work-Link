{% import "components/navbar.jinja2" as components %}
{% import 'components/footer.jinja2' as footer %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WorkLink – Job Listings</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style_empleos.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style_index.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="{{ url_for('static', filename='js/script_empleos.js') }}"></script>
  
  <!-- Script para manejar el cierre automático de mensajes flash -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Cerrar mensajes flash al hacer clic en el botón de cerrar
      document.querySelectorAll('.alert .close').forEach(button => {
        button.addEventListener('click', function() {
          this.closest('.alert').style.opacity = '0';
          setTimeout(() => {
            this.closest('.alert').remove();
          }, 300);
        });
      });
      
      // Cerrar automáticamente los mensajes después de 5 segundos
      setTimeout(() => {
        document.querySelectorAll('.alert').forEach(alert => {
          alert.style.opacity = '0';
          setTimeout(() => {
            alert.remove();
          }, 300);
        });
      }, 5000);
    });
  </script>
</head>
<body>

  {{ components.navbar( current_user) }}

  <!-- Flash Messages -->
  <div class="flash-messages">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <!-- Hero Section -->
  <section class="hero-section" data-aos="fade-up" data-aos-delay="50">
    <div class="hero-image">
      <img src="https://www.acceptmission.com/wp-content/uploads/2021/05/Blogbanner-Business-Development-vs-Innovation-Whats-the-Difference-800x267.png.webp"
           alt="Job Opportunities">
      <div class="hero-overlay">
        <h1>Find Your Dream Job, Anywhere</h1>
        <p>
          Explore thousands of opportunities from top companies worldwide.
          Your next career move is just a click away with WorkLink.
        </p>
        <!--button class="btn-orange">Explore Job Opportunities</!--button-->
      </div>
    </div>
  </section>

  <!-- Filters Section -->
  <section class="filters-section" data-aos="fade-up" data-aos-delay="100">
    <div class="filters-container">
      <input id="filter-q" type="text" placeholder="Buscar por palabra clave" />
      <select id="filter-location">
        <option value="">Ubicación</option>
        {% for loc in locations or [] %}
        <option value="{{ loc }}">{{ loc }}</option>
        {% endfor %}
      </select>
      <select id="filter-job-type">
        <option value="">Tipo de empleo</option>
        {% for jt in job_types or [] %}
        <option value="{{ jt }}">{{ jt }}</option>
        {% endfor %}
      </select>
      <select id="filter-salary">
        <option value="">Salario</option>
        {% for s in salaries or [] %}
        <option value="{{ s }}">${{ '%.2f'|format(s) }}</option>
        {% endfor %}
      </select>
      <button id="apply-filters" class="btn-dark">Aplicar filtros</button>
      <button id="clear-filters" class="btn-dark" style="background:#666">Limpiar</button>
    </div>
  </section>

  <!-- Job Listings -->
  <section class="jobs-section" data-aos="fade-up" data-aos-delay="150" data-current-page="{{ current_page|default(1) }}" data-total-pages="{{ total_pages|default(1) }}" data-per-page="{{ per_page|default(9) }}" data-total-items="{{ total_items|default(vacantes|length) }}">
    <h2>Empleos publicados recientemente</h2>

    <div class="jobs-grid" id="jobs-grid">
      {% include 'empleos/cards_empleos.jinja2' with context %}
    </div>

    <!-- Paginado -->
    <div class="pagination-container" data-aos="fade-up" data-aos-delay="200">
      <div class="pagination" id="pagination">
        <!-- Se llena dinámicamente con JS -->
      </div>
      <div class="pagination-info" id="pagination-info">
        <!-- Se llena dinámicamente con JS -->
      </div>
    </div>
  </section>

  <!-- Llamar al componente footer -->
  {{ footer.footer() }}
  <!-- Inicializar AOS -->
  <script>
      AOS.init();
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const section = document.querySelector('.jobs-section');
      const grid = document.getElementById('jobs-grid');
      const paginationEl = document.getElementById('pagination');
      const infoEl = document.getElementById('pagination-info');
      let totalPages = parseInt(section.getAttribute('data-total-pages')) || 1;
      const perPage = parseInt(section.getAttribute('data-per-page')) || 9;
      let totalItems = parseInt(section.getAttribute('data-total-items')) || 0;
      let currentPage = parseInt(section.getAttribute('data-current-page')) || 1;

      // Filtros DOM
      const qInput = document.getElementById('filter-q');
      const locationSel = document.getElementById('filter-location');
      const jobTypeSel = document.getElementById('filter-job-type');
      const salarySel = document.getElementById('filter-salary');
      const applyBtn = document.getElementById('apply-filters');
      const clearBtn = document.getElementById('clear-filters');

      function getFilterParams() {
        const params = new URLSearchParams();
        if (qInput.value.trim()) params.set('q', qInput.value.trim());
        if (locationSel.value) params.set('location', locationSel.value);
        if (jobTypeSel.value) params.set('job_type', jobTypeSel.value);
        if (salarySel.value) params.set('salary', salarySel.value);
        return params.toString();
      }

      function updateInfo() {
        const start = totalItems === 0 ? 0 : (currentPage - 1) * perPage + 1;
        const end = Math.min(currentPage * perPage, totalItems);
        infoEl.innerHTML = `<span>Mostrando ${start}-${end} de ${totalItems} empleos</span>`;
      }

      function buildPagination() {
        const createBtn = (label, page, disabled = false, active = false, cls = '') => {
          const btn = document.createElement('button');
          btn.className = `${cls} ${active ? 'active' : ''}`.trim();
          btn.disabled = disabled;
          btn.textContent = label;
          if (!disabled) {
            btn.addEventListener('click', () => loadPage(page));
          }
          return btn;
        };

        paginationEl.innerHTML = '';
        const prev = createBtn('Anterior', Math.max(1, currentPage - 1), currentPage === 1, false, 'pagination-btn prev-btn');
        const next = createBtn('Siguiente', Math.min(totalPages, currentPage + 1), currentPage === totalPages, false, 'pagination-btn next-btn');

        const numbers = document.createElement('div');
        numbers.className = 'pagination-numbers';

        const pagesToShow = [];
        const add = (p) => { if (p >= 1 && p <= totalPages && !pagesToShow.includes(p)) pagesToShow.push(p); };
        add(1); add(2); add(totalPages); add(totalPages - 1); add(currentPage); add(currentPage - 1); add(currentPage + 1);
        pagesToShow.sort((a,b)=>a-b);

        let last = 0;
        pagesToShow.forEach(p => {
          if (p - last > 1) {
            const span = document.createElement('span');
            span.className = 'pagination-dots';
            span.textContent = '...';
            if (last !== 0) numbers.appendChild(span);
          }
          numbers.appendChild(createBtn(String(p), p, false, p === currentPage, 'pagination-number'));
          last = p;
        });

        paginationEl.appendChild(prev);
        paginationEl.appendChild(numbers);
        paginationEl.appendChild(next);
      }

      async function loadPage(page, force = false) {
        if (page === currentPage && !force) {
          // Aun así recargar si filtros cambiaron, 'force' lo manejará el caller
        }
        const qp = getFilterParams();
        const url = `{{ url_for('EmpleosRoute.empleos_page') }}?page=${page}&per_page=${perPage}${qp ? '&' + qp : ''}`;
        try {
          const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          if (!res.ok) throw new Error('Error al cargar página');
          const data = await res.json();
          grid.innerHTML = data.html;
          currentPage = data.current_page;
          totalPages = data.total_pages;
          totalItems = data.total_items;
          section.setAttribute('data-current-page', currentPage);
          buildPagination();
          updateInfo();
          // Re-inicializar AOS para nuevos elementos
          if (window.AOS && AOS.refresh) { AOS.refresh(); }
          // Scroll al inicio de la sección
          section.scrollIntoView({ behavior: 'smooth' });
        } catch (e) {
          console.error(e);
        }
      }

      // Handlers filtros
      applyBtn.addEventListener('click', () => {
        loadPage(1, true);
      });

      clearBtn.addEventListener('click', () => {
        qInput.value = '';
        locationSel.value = '';
        jobTypeSel.value = '';
        salarySel.value = '';
        loadPage(1, true);
      });

      buildPagination();
      updateInfo();
    });
  </script>

</body>
</html>
